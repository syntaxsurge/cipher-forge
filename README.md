# CipherForge

CipherForge is a Next.js 15 + Convex + Stellar testnet project for ZK gaming.

## Current capabilities

- SEP-10 wallet authentication with JWT-backed Convex identity checks
- Creator forge flow for draft challenge creation and listing (`/forge`)
- Secret-word challenge type with Blake2s commitment storage only
- Browser-side Noir witness execution + UltraHonk proof generation in a Web Worker
- Dedicated proof workbench route (`/forge/[challengeId]/prove`) with local verification output
- Day 4 proof workbench integration with generated Soroban TypeScript bindings (`cipherforge_game`) for `create_session` and `submit_proof` transactions signed in-browser via Freighter
- Day 5 judge-ready UX with `/judge` walkthrough, copyable testnet contract IDs, and deterministic docs export
- Day 3 Soroban on-chain workspace with:
  - `cipherforge-game` game contract (Game Hub `start_game` and `end_game` integration)
  - vendored `rs-soroban-ultrahonk` verifier contract source under `vendor/rs-soroban-ultrahonk`
  - testnet deployment + smoke test automation scripts

## Prerequisites

- Node.js 20+
- pnpm 9+
- Rust + Cargo + `wasm32v1-none`
- Stellar CLI
- Convex account login
- Noir CLI (`nargo`) and Barretenberg CLI (`bb`) for circuit compilation

Noir + bb can be installed manually, but Day 3 artifact script also installs pinned versions used by the verifier test fixtures.

## Environment setup

1. Copy app template:

```bash
cp .env.example .env.local
```

2. Copy blockchain template:

```bash
cp blockchain/.env.example blockchain/.env
```

3. Generate auth materials for SEP-10/JWT and place in `.env.local`:

```bash
openssl genpkey -algorithm RSA -pkeyopt rsa_keygen_bits:2048 -out keys/cf_jwt_private.pem
base64 < keys/cf_jwt_private.pem | tr -d '\n'
```

```bash
node -e "console.log(require('crypto').randomBytes(32).toString('base64url'))"
```

```bash
node -e "const { Keypair } = require('@stellar/stellar-sdk'); const kp = Keypair.random(); console.log('PUBLIC=' + kp.publicKey()); console.log('SECRET=' + kp.secret());"
```

4. Set `CF_AUTH_JWKS` with:

```bash
pnpm auth:print-jwks-data-uri
```

5. Ensure `NEXT_PUBLIC_CONVEX_URL` exists (generated by `pnpm convex:dev`).

## Install dependencies

```bash
pnpm install
```

## Day 2 (browser ZK) commands

```bash
pnpm zk:build
pnpm zk:write-vk
```

## Day 3 (on-chain) commands

### 1) Generate verifier artifacts

```bash
pnpm soroban:build-artifacts
```

### 2) Build Soroban contracts

```bash
pnpm soroban:build-contracts
```

### 3) Create/fund testnet identities

```bash
stellar keys generate alice --network testnet --fund --overwrite
stellar keys generate bob --network testnet --fund --overwrite
```

### 4) Deploy verifier contract

```bash
pnpm soroban:deploy-verifier:testnet
```

Output includes `VERIFIER_CONTRACT_ID=...`.

### 5) Deploy game contract

```bash
STELLAR_VERIFIER_CONTRACT_ID=<verifier_contract_id> pnpm soroban:deploy-game:testnet
```

Output includes `GAME_CONTRACT_ID=...`.

### 6) Run smoke test

Proof-mode (attempt real verifier path):

```bash
STELLAR_GAME_CONTRACT_ID=<game_contract_id> pnpm soroban:smoke:testnet
```

Timeout-mode (deterministic testnet settlement path calling `end_game`):

```bash
STELLAR_GAME_CONTRACT_ID=<game_contract_id> STELLAR_SMOKE_MODE=timeout pnpm soroban:smoke:testnet
```

All-in-one pipeline:

```bash
pnpm soroban:day3:testnet
```

`pnpm soroban:day3:testnet` defaults to `STELLAR_SMOKE_MODE=timeout` so the pipeline can complete deterministically on testnet while still exercising required Game Hub lifecycle calls.

## Day 4 (frontend contract wiring) commands

### 1) Generate and link TypeScript contract bindings

```bash
STELLAR_GAME_CONTRACT_ID=<game_contract_id> pnpm soroban:bindings:testnet
```

The script regenerates `packages/cipherforge_game`, builds the package, and links it into the Next.js app as a local dependency.

### 2) Run app and execute the Day 4 flow

Terminal A:

```bash
pnpm convex:dev
```

Terminal B:

```bash
pnpm dev
```

Open `/forge/<challenge_id>/prove` and execute:

1. Generate proof in-browser.
2. Start on-chain session (`create_session`) from the creator wallet.
3. Submit proof bytes + concatenated public input bytes (`submit_proof`) from the challenger wallet.

## Day 5 (submission hardening) commands

### 1) Export testnet contract/rpc docs from Stellar aliases

```bash
pnpm contracts:export:testnet
```

This generates:

- `docs/contracts.testnet.json`
- `docs/.env.testnet.public`

### 2) Judge walkthrough route

```txt
/judge
```

Use this route to run the full verification flow with explicit page-by-page actions and copyable IDs.

### 3) Release checks

```bash
pnpm release:check
```

Runs lint, typecheck, and production build in sequence.

## Local app run

Terminal A:

```bash
pnpm convex:dev
```

Terminal B:

```bash
pnpm dev
```

Open `http://localhost:3000/forge`.

## Quality checks

```bash
pnpm typecheck
pnpm lint
pnpm build
pnpm release:check
```

## Latest testnet deployment (Day 3)

- Verifier contract: `CDRSRUNXDIWGWWRWPFZOQBRNBSBQ3FF7HWQ2747ZFI2UOAZXZ56667N7`
- Game contract: `CDXECE4SPIO3ULEBTCOXS6B64OUMRMU6MABEFV2EE3KCIQJM7JZPJQZC`

## Judge assets

- Judge flow page: `/judge`
- Testnet config export: `docs/contracts.testnet.json`
- Public env export: `docs/.env.testnet.public`
- Demo script: `docs/DEMO_SCRIPT.md`

## Notes

- On current testnet limits, proof-mode smoke verification can fail with `Budget Exceeded` for the bundled verifier fixture; timeout-mode still validates required Game Hub lifecycle calls on testnet.
- The game contract always calls the required hub methods: `start_game()` at session creation and `end_game()` at settlement.
